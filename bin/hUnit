#!/usr/bin/hhvm
<?hh
//
// Copyright 2018 hUnit project developers.
// See COPYRIGHT.txt
// 
// This file is part of the hUnit project and subject to license terms.
// See LICENSE.txt
// 

namespace hUnit;

require_once dirname(__FILE__) . "/../src/Options.hh";
require_once dirname(__FILE__) . "/../src/TestSuiteLoader.hh";
require_once dirname(__FILE__) . "/../src/hUnit.hh";

$options = Options::instance();

if($options->showHelp()) {
    print("Usage: hUnit [options]\n");
    print("  Options: \n");
    print("    -d <directory>, a directory containing unit tests\n");
    print("    -n <namespace>, a specified namespace to run unit tests\n");
    print("    -l, list test suites organized by namespace\n");
    print("    -h, display this help message\n");
    print("  Example:\n");
    print("    hUnit [-l] -d <directory> [-d <directory>...] [-n <namespace>...]\n");

    exit(Exit::OK);
}

$testSuiteLoader = TestSuiteLoader::instance(); 

$namespaceNames = $options->namespaceNames();

if(!$namespaceNames->count()) {
    $namespaceNames = $testSuiteLoader->getNamespaceNames();
}

if($options->listTests()) {
    foreach($namespaceNames as $namespaceName) {
        print("$namespaceName\n");

        foreach($testSuiteLoader->getTestSuitesByNamespace($namespaceName) as $testSuite) {
            $testSuiteName = $testSuite->getShortName();

            print("    $testSuiteName\n");
        }

        print("\n");
    }
} else {
    $testSuites = Vector{}; 

    foreach($namespaceNames as $namespaceName) {
        foreach($testSuiteLoader->getTestSuitesByNamespace($namespaceName) as $testSuite) {
            $testSuites[] = $testSuite;
        }
    }

    exit((new hUnit($testSuites))->run()); 
}
